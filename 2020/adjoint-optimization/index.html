<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Adjoint Optimization | cat /var/log/life</title>
        <meta name="Description" content="cat /var/log/life"><meta property="og:title" content="Adjoint Optimization" />
<meta property="og:description" content="伴随优化基本方程的推导以及OpenFOAM中的实现" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://fr13ndsdp.github.io/2020/adjoint-optimization/" />
<meta property="article:published_time" content="2020-12-03T00:38:02+08:00" />
<meta property="article:modified_time" content="2020-12-03T00:38:02+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Adjoint Optimization"/>
<meta name="twitter:description" content="伴随优化基本方程的推导以及OpenFOAM中的实现"/>
<meta name="application-name" content="Fr13ndSDP">
<meta name="apple-mobile-web-app-title" content="Fr13ndSDP"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://fr13ndsdp.github.io/2020/adjoint-optimization/" /><link rel="prev" href="https://fr13ndsdp.github.io/2020/optimize-code/" /><link rel="next" href="https://fr13ndsdp.github.io/2020/ferziger-on-les/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Adjoint Optimization",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/fr13ndsdp.github.io\/2020\/adjoint-optimization\/"
        },"image": {
                "@type": "ImageObject",
                "url": "https:\/\/fr13ndsdp.github.io\/cover.png",
                "width":  800 ,
                "height":  600 
            },"genre": "posts","keywords": "Adjoint Method","wordcount":  3491 ,
        "url": "https:\/\/fr13ndsdp.github.io\/2020\/adjoint-optimization\/","datePublished": "2020-12-03T00:38:02+08:00","dateModified": "2020-12-03T00:38:02+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
                "@type": "Organization",
                "name": "xxxx",
                "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/fr13ndsdp.github.io\/logo.png",
                "width":  127 ,
                "height":  40 
                }
            },"author": {
                "@type": "Person",
                "name": "Fr13ndSDP"
            },"description": ""
    }
    </script></head>
    <body><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="cat /var/log/life"><i class='fas fa-terminal'></i> cat /var/log/life</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"><i class='fas fa-book'></i> 所有文章 </a><a class="menu-item" href="/tags/"><i class='fas fa-tags'></i> 标签 </a><a class="menu-item" href="/categories/"><i class='fas fa-sitemap'></i> 分类 </a><a class="menu-item" href="/about/"><i class='far fa-address-card'></i> 关于 </a><a class="menu-item" href="https://github.com/Fr13ndSDP" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="cat /var/log/life"><i class='fas fa-terminal'></i> cat /var/log/life</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title=""><i class='fas fa-book'></i>所有文章</a><a class="menu-item" href="/tags/" title=""><i class='fas fa-tags'></i>标签</a><a class="menu-item" href="/categories/" title=""><i class='fas fa-sitemap'></i>分类</a><a class="menu-item" href="/about/" title=""><i class='far fa-address-card'></i>关于</a><a class="menu-item" href="https://github.com/Fr13ndSDP" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Adjoint Optimization</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Fr13ndSDP</a></span>&nbsp;
                    <span class="post-category">收录于<a href="/categories/cfd/">
                                <i class="far fa-folder fa-fw"></i>CFD
                            </a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-12-03>2020-12-03</time>&nbsp;
                <i class="fas fa-pencil-alt fa-fw"></i>约 3491 字&nbsp;
                <i class="far fa-clock fa-fw"></i>预计阅读 7 分钟&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading/normal.min.svg"
        data-sizes="auto"
        data-srcset="/images/Adjoint-Method/Adjoint.png, /images/Adjoint-Method/Adjoint.png 1.5x, /images/Adjoint-Method/Adjoint.png 2x"
        data-src="/images/Adjoint-Method/Adjoint.png"
        alt="/images/Adjoint-Method/Adjoint.png"
        title="/images/Adjoint-Method/Adjoint.png" /></div><div class="details toc" id="toc-static">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-伴随方法">1 伴随方法</a>
      <ul>
        <li><a href="#11-动机">1.1 动机</a></li>
        <li><a href="#12-推导">1.2 推导</a></li>
      </ul>
    </li>
    <li><a href="#2-pde约束的连续伴随问题">2 PDE约束的连续伴随问题</a>
      <ul>
        <li><a href="#21-一般伴随方程">2.1 一般伴随方程</a></li>
        <li><a href="#22-边界条件">2.2 边界条件</a></li>
      </ul>
    </li>
    <li><a href="#3-特定问题目标函数为能量损失">3 特定问题—目标函数为能量损失</a></li>
    <li><a href="#4-openfoam-中的实现">4. <em>OpenFOAM</em> 中的实现</a>
      <ul>
        <li><a href="#41-原始方程和伴随方程的求解">4.1 原始方程和伴随方程的求解</a></li>
        <li><a href="#42-边界条件的处理">4.2 边界条件的处理</a></li>
        <li><a href="#43-梯度下降法-deepest-descent-method">4.3 梯度下降法 （Deepest descent method）</a></li>
        <li><a href="#44-算例">4.4 算例</a></li>
      </ul>
    </li>
    <li><a href="#5-总结">5. 总结</a>
      <ul>
        <li>
          <ul>
            <li><a href="#参考资料">参考资料</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>伴随优化基本方程的推导以及OpenFOAM中的实现</p>
<blockquote>
<p>使用如下的符号记法：全导数 $d_x$ $(\nabla_x)$，偏导 $\partial_x$，微分 $d$.</p>
</blockquote>
<h2 id="1-伴随方法">1 伴随方法</h2>
<p>在一个偏微分方程系统中，假设存在变量 $x\in R^{n_x}, p\in R^{n_p}$，方程 $f(x,p):R^{n_x}\times R^{n_p}\rightarrow R$以及关系 $g(x,p) = 0$，且 $g_x$ 处处非奇异，$d_pf$怎么求？</p>
<h3 id="11-动机">1.1 动机</h3>
<p>$g(x,p)=0$ 的求解是CFD求解器的核心，给定参数 $p$，程序将计算出 $x$。例如 $p$ 可以是边界条件或初始条件的参数，也可以是物性参数，而 $x$ 是计算得到的场量，这种求解模式是<em>正问题</em>。如果引入 $f(x,p)$作为度量标准，例如用来计算 $x$ 的光滑程度，那么通常需要最小化$f$，这种求解模式是<em>反问题</em>。</p>
<p>梯度 $d_pf$ 很有用，可以用来计算优化问题 $min_pf$ 中 $f$ 对于参数 $p$ 变化的敏感程度，并使用梯度下降方法求解最优化问题。</p>
<h3 id="12-推导">1.2 推导</h3>
<p>1）</p>
<p>考虑一个简单的函数 $f(x)$，首先由链式法则有
$$
d_pf = d_df(x(p)) = \partial_xfd_px\ (=f_xx_p)
$$
其次因为 $g(x,p) = 0$ 处处成立，则 $d_pg = 0$， 也就是
$$
g_xx_p + g_p = 0
$$
那么得到
$$
d_pf = -f_xg_x^{-1}g_p
$$
从线性代数的观点看，$f_xg_x^{-1}$ 是一个行向量乘以 $n_x\times n_x$ 的矩阵，并且是以下方程的解
$$
g_x^{T}\lambda = -f_x^{T}
$$
称为伴随方程，$\lambda$称为伴随变量。得到 $d_pf = \lambda^Tg_p$</p>
<p>2）</p>
<p>定义拉格朗日函数
$$
L(x,p,\lambda) = f(x) + \lambda^Tg(x,p)
$$
这里$\lambda$是拉格朗日乘子组成的向量，由于 $g(x,p)$ 处处为零，$\lambda$可以随意选取。
$$
d_pf(x) = d_pL = f_xx_p + d_p\lambda^Tg + \lambda^T(g_xx_p+g_p)\\ =(f_x+\lambda^Tg_x)x_p+\lambda^Tg_p
$$
如果选取 $g^T\lambda = -f_x^T$，第一项为零，可以避免计算 $x_p$ 并且得到 $d_pf = \lambda^Tg_p$，与第一种推导方式相同。</p>
<p>或者，由于$df = f_xdx +f_pdp = (f_x+\lambda^Tg_x )dx+ \lambda^Tg_pdp$，可以推至同样的结果。</p>
<h2 id="2-pde约束的连续伴随问题">2 PDE约束的连续伴随问题</h2>
<h3 id="21-一般伴随方程">2.1 一般伴随方程</h3>
<p>给出一个特定的优化问题
$$
min\quad J = J(\mathbf{v}, p, \alpha)\\ s.t.\quad R(\mathbf{v},p,\alpha) = 0
$$
考虑由连续介质力学给出的约束，$\mathbf{v}$ 与 $p$ 作为变量，即等价为前文中的 $x$; $\alpha$ 作为 设计参数，即等价于前文中的$p$，给出问题
$$
min\quad J = J(\mathbf{v},p,\alpha)\\ s.t. \quad R^{u} = \nabla\cdot(\mathbf{vv}) + \nabla p - \nabla\cdot(2\nu D(\mathbf{v}))+\alpha \mathbf{v} = 0\\ R^{p} = \nabla \cdot \mathbf{v} = 0
$$
上式由达西定律引入了渗透率作为源项，假设某一区域使得目标函数增大，可以通过减小这一区域的渗透率作为惩罚。$D(\mathbf{v})=\frac{1}{2}(\nabla \mathbf{v}+\nabla \mathbf{v}^T)$ 代表应变率张量。</p>
<p>使用拉格朗日乘数法将其转变为无约束优化问题
$$
min \quad L = J+\int_\Omega(\mathbf{u},q)Rd\Omega\\ = J+ \int_{\Omega}qR^pd\Omega + \int_\Omega{\mathbf{u}\cdot R^{u}}d\Omega
$$
其中$(\mathbf{u},q)$为拉格朗日乘子，称其为伴随速度和伴随压力（后面会看到为什么），但是实际上并没有物理含义。</p>
<p>因为变分
$$
\delta L = \delta_{\alpha}L+ \delta_{\mathbf{v}}L+\delta_{p}L
$$
注意这里没有将粘度作为微分变量，是一种近似的做法，被称为“冻结湍流”。</p>
<p>由于 $(\mathbf{u},q)$可以自由选取，取 适当的值使得 $\delta_{\mathbf{v}}L+\delta_pL = 0$ 成立，便得到
$$
\delta_{\alpha}L = \delta_{\alpha}J + \int_{\Omega}\mathbf{u}\cdot \mathbf{v}d\Omega
$$
当考虑网格中的目标函数关于 $\alpha$的梯度，可以得到
$$
\frac{\partial L}{\partial \alpha_i} =  \frac{\partial J}{\partial\alpha_i} + \mathbf{u_i}\cdot \mathbf{v_i}V_i
$$
其中 $V_i$ 为网格体积。</p>
<p>如果 $\delta_{\mathbf{v}}L+\delta_pL = 0$ 成立，那么伴随方程
$$
\delta_{\mathbf{v}}J + \delta_{p}J +
\int_{\Omega}\mathbf{u}\cdot [\nabla\cdot(\mathbf{v\delta v})+\nabla\cdot(\mathbf{\delta v v})   - \nabla\cdot(2\nu D(\delta\mathbf{v}))+\alpha \delta \mathbf{v}]d\Omega \\ - \int_{\Omega}q\nabla \cdot \delta \mathbf{v}d\Omega + \int_{\Omega}\mathbf{u}\cdot \nabla \delta pd\Omega = 0
$$
积分使用散度公式与高斯散度定理(以及一些张量运算的推导)：
$$
\nabla\cdot (q\mathbf{v}) = \nabla q \cdot \mathbf{v}+q\nabla \cdot \mathbf{v}\\ \int_{\Omega}\nabla \cdot (q\mathbf{v})\ d\Omega =\int_{\Gamma}q\mathbf{ v}\cdot \mathbf{n}d\Gamma
$$
并且把 $J$ 拆分为
$$
J = \int_{\Gamma}J_{\Gamma}\ d\Gamma + \int_{\Omega} J_{\Omega}\ d\Omega
$$
得到  (*注意*  $(\mathbf{v}\cdot \nabla)\mathbf{u}=\nabla(\mathbf{vu})$）
$$
\int_{\Gamma} \mathrm{d} \Gamma\left(\mathbf{u} \cdot \mathbf{n}+\frac{\partial J_{\Gamma}}{\partial p}\right) \delta p+\int_{\Omega} \mathrm{d} \Omega\left(-\nabla \cdot \mathbf{u}+\frac{\partial J_{\Omega}}{\partial p}\right) \delta p\\ \quad+\int_{\Gamma} \mathrm{d} \Gamma\left(\mathbf{n}(\mathbf{u} \cdot \mathbf{v})+\mathbf{u}(\mathbf{v} \cdot \mathbf{n})+2 v \mathbf{n} \cdot \mathbf{D}(\mathbf{u})-q \mathbf{n}+\frac{\partial J_{\Gamma}}{\partial \mathbf{v}}\right) \cdot \delta \mathbf{v}-\int_{\Gamma} \mathrm{d} \Gamma 2 v \mathbf{n} \cdot \mathbf{D}(\delta \mathbf{v}) \cdot \mathbf{u}\\ \quad+\int_{\Omega} \mathrm{d} \Omega\left(-\nabla \mathbf{u} \cdot \mathbf{v}-(\mathbf{v} \cdot \nabla) \mathbf{u}-\nabla \cdot(2 v \mathbf{D}(\mathbf{u}))+\alpha \mathbf{u}+\nabla q+\frac{\partial J_{\Omega}}{\partial \mathbf{v}}\right) \cdot \delta \mathbf{v}=0
$$</p>
<p>观察上面的式子，他应该对任意的 $\delta \mathrm{p}$和 $\delta \mathbf{v}$ 成立，因此各个积分分别等于0，当在 $\Omega$ 内积分时，边界积分为零，因此得到 $\Omega$ 内的伴随方程
$$
-\nabla (\mathbf{vu})-\nabla \mathbf{u}\cdot \mathbf{v} = -\nabla{q}+\nabla \cdot (2\nu D(\mathbf{u}))-\alpha \mathbf{u} - \frac{\partial J_{\Omega}}{\partial \mathbf{v}}\\ \nabla \cdot \mathbf{u} = \frac{\partial J_{\Omega}}{\partial p}
$$
可以看到，这组方程与 N-S 方程非常相似，因此变量 $(\mathbf{u}, q)$ 被看作是非物理的速度和压力。</p>
<h3 id="22-边界条件">2.2 边界条件</h3>
<p>在边界处，可以得到边界条件为
$$
\int_{\Gamma} \mathrm{d} \Gamma\left(\mathbf{n}(\mathbf{u} \cdot \mathbf{v})+\mathbf{u}(\mathbf{v} \cdot \mathbf{n})+2 v \mathbf{n} \cdot \mathbf{D}(\mathbf{u})-q \mathbf{n}+\frac{\partial J_{\Gamma}}{\partial \mathbf{v}}\right) \cdot \delta \mathbf{v}-\int_{\Gamma} \mathrm{d} \Gamma 2 v \mathbf{n} \cdot \mathbf{D}(\delta \mathbf{v}) \cdot \mathbf{u}=0\\ \int_{\Gamma} \mathrm{d} \Gamma\left(\mathbf{u} \cdot \mathbf{n}+\frac{\partial J_{\Gamma}}{\partial p}\right) \delta p=0
$$
或者
$$
\int_{\Gamma} \mathrm{d} \Gamma\left(\mathbf{n}(\mathbf{u} \cdot \mathbf{v})+\mathbf{u}(\mathbf{v} \cdot \mathbf{n})+2 v \mathbf{n} \cdot \mathbf{D}(\mathbf{u})-q \mathbf{n}+\frac{\partial J_{\Gamma}}{\partial \mathbf{v}}\right) \cdot \delta \mathbf{v}=0\\ \int_{\Gamma} \mathrm{d} \Gamma\left(\mathbf{u} \cdot \mathbf{n}+\frac{\partial J_{\Gamma}}{\partial p}\right) \delta p + \int_{\Gamma} \mathrm{d} \Gamma 2 v \mathbf{n} \cdot \mathbf{D}(\delta \mathbf{v}) \cdot \mathbf{u}=0
$$</p>
<p>1） 在入口边界以及壁面处，速度值为给定值或者0，因此 $\delta \mathbf{v} = 0$，因此部分积分可以视为0，为了避免无解，显然应该选取第一种边界条件的定义。</p>
<p>因此
$$
\int_{\Gamma} \mathrm{d} \Gamma 2 v \mathbf{n} \cdot \mathbf{D}(\delta \mathbf{v}) \cdot \mathbf{u}=0 \\ u_n = -\frac{\partial J_{\Gamma}}{\partial p}
$$
其中 $u_n = \mathbf{u\cdot n}$ 为伴随速度在边界法向的分量。现在需要定义$u_t$ 在边界处的取值，这里需要用到一些近似，具体推导参看参考文献1，这里直接给出入口及壁面处应该满足的边界条件：
$$
u_t = 0\\ u_n = -\frac{\partial J_{\Gamma}}{\partial p}\\ \mathbf{n}\cdot \nabla q = 0
$$
2) 出口边界常见设为压力为零和速度零梯度，因此除了自动满足的积分，边界条件剩下
$$
\mathbf{n}(\mathbf{u} \cdot \mathbf{v})+\mathbf{u}(\mathbf{v} \cdot \mathbf{n})+v(\mathbf{n} \cdot \nabla) \mathbf{u}-q \mathbf{n}+\frac{\partial J_{\Gamma}}{\partial \mathbf{v}}=0
$$</p>
<h2 id="3-特定问题目标函数为能量损失">3 特定问题—目标函数为能量损失</h2>
<p>选取目标函数为流动的能量损失，即最小化能量损失
$$
J = -\int_{\Gamma}(p+\frac{1}{2}v^2)\mathbf{v}\cdot \mathbf{n}\ d\Gamma
$$
负号是因为考虑到通量的方向，即最小化进出口能量之差。</p>
<p>$J_{\Omega} = 0, J_{\Gamma} = -(p+\frac{1}{2}v^2)\mathbf{v\cdot n}$，因此
$$
\frac{\partial J_{\Gamma}}{\partial p} = -\mathbf{v\cdot n},\quad \frac{\partial J_{\Gamma}}{\partial \mathbf{v}} = \frac{\partial(-p\mathbf{v\cdot n}-\frac{1}{2}\mathbf{(v\cdot v)v\cdot n)}}{\partial\mathbf{v}} = -p\mathbf{n}-(\mathbf{v\cdot n})\cdot \mathbf{v}-\frac{1}{2}v^2\mathbf{n}
$$</p>
<p>代入伴随方程，得到在 $\Omega$ 内
$$
-\nabla (\mathbf{vu})-\nabla \mathbf{u}\cdot \mathbf{v} = -\nabla{q}+\nabla \cdot (2\nu D(\mathbf{u}))-\alpha \mathbf{u}\\ \nabla \cdot \mathbf{u} = 0
$$
入口边界条件：
$$
u_t = 0\\ u_n = v_n\\ \mathbf{n}\cdot \nabla q = 0
$$
出口边界条件：
$$
\mathbf{n}(\mathbf{u} \cdot \mathbf{v})+\mathbf{u}(\mathbf{v} \cdot \mathbf{n})+v(\mathbf{n} \cdot \nabla) \mathbf{u}-q \mathbf{n}-p\mathbf{n}-(\mathbf{v\cdot n})\cdot \mathbf{v}-\frac{1}{2}v^2\mathbf{n}=0
$$</p>
<h2 id="4-openfoam-中的实现">4. <em>OpenFOAM</em> 中的实现</h2>
<p>首先给出算法流程图：</p>
<figure>
    <img src="/images/Adjoint-Method/procedure.png"/> <figcaption>
            <h4>What&#39;s next</h4>
        </figcaption>
</figure>

<h3 id="41-原始方程和伴随方程的求解">4.1 原始方程和伴随方程的求解</h3>
<p>首先，使用SIMPLE算法求解原始变量</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// Momentum predictor
</span><span class="c1"></span>            <span class="c1">// @turbulence-&gt;divDevSigma: 湍流源项，应变率张量散度
</span><span class="c1"></span>            <span class="n">fvVectorMatrix</span> <span class="nf">UEqn</span>
            <span class="p">(</span>
                <span class="n">fvm</span><span class="o">::</span><span class="n">div</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
              <span class="o">+</span> <span class="n">turbulence</span><span class="o">-&gt;</span><span class="n">divDevSigma</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
              <span class="o">+</span> <span class="n">fvm</span><span class="o">::</span><span class="n">Sp</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
            <span class="p">);</span>
			<span class="n">UEqn</span><span class="p">.</span><span class="n">relax</span><span class="p">();</span>
			<span class="n">solve</span><span class="p">(</span><span class="n">UEqn</span> <span class="o">==</span> <span class="o">-</span><span class="n">fvc</span><span class="o">::</span><span class="n">grad</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
<span class="c1">// omit-----------------------------------------------------
</span><span class="c1">//压力泊松方程
</span><span class="c1"></span>			<span class="n">volScalarField</span> <span class="nf">rAU</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">UEqn</span><span class="p">.</span><span class="n">A</span><span class="p">());</span>
            <span class="n">volVectorField</span> <span class="nf">HbyA</span><span class="p">(</span><span class="n">constrainHbyA</span><span class="p">(</span><span class="n">rAU</span><span class="o">*</span><span class="n">UEqn</span><span class="p">.</span><span class="n">H</span><span class="p">(),</span> <span class="n">U</span><span class="p">,</span> <span class="n">p</span><span class="p">));</span>
            <span class="n">surfaceScalarField</span> <span class="nf">phiHbyA</span><span class="p">(</span><span class="s">&#34;phiHbyA&#34;</span><span class="p">,</span> <span class="n">fvc</span><span class="o">::</span><span class="n">flux</span><span class="p">(</span><span class="n">HbyA</span><span class="p">));</span>
			<span class="n">fvScalarMatrix</span> <span class="nf">pEqn</span>
            <span class="p">(</span>
            	<span class="n">fvm</span><span class="o">::</span><span class="n">laplacian</span><span class="p">(</span><span class="n">rAU</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="n">fvc</span><span class="o">::</span><span class="n">div</span><span class="p">(</span><span class="n">phiHbyA</span><span class="p">)</span>
            <span class="p">);</span>

            <span class="n">pEqn</span><span class="p">.</span><span class="n">setReference</span><span class="p">(</span><span class="n">pRefCell</span><span class="p">,</span> <span class="n">pRefValue</span><span class="p">);</span>
            <span class="n">pEqn</span><span class="p">.</span><span class="n">solve</span><span class="p">();</span>
<span class="c1">// Explicitly relax pressure for momentum corrector
</span><span class="c1"></span>            <span class="n">p</span><span class="p">.</span><span class="n">relax</span><span class="p">();</span>
<span class="c1">// Momentum corrector
</span><span class="c1"></span>            <span class="n">U</span> <span class="o">=</span> <span class="n">HbyA</span> <span class="o">-</span> <span class="n">rAU</span><span class="o">*</span><span class="n">fvc</span><span class="o">::</span><span class="n">grad</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>也就是求解
$$
\nabla\cdot(\mathbf{vv}) + \nabla p - \nabla\cdot (2\nu D(\mathbf{v}))+\alpha \mathbf{v} = 0\\ \nabla \cdot \mathbf{v} = 0
$$</p>
<p>然后求解伴随方程（与原始变量方程非常相似）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// Adjoint Momentum predictor
</span><span class="c1"></span>            <span class="n">volVectorField</span> <span class="nf">adjointTransposeConvection</span><span class="p">((</span><span class="n">fvc</span><span class="o">::</span><span class="n">grad</span><span class="p">(</span><span class="n">Ua</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">U</span><span class="p">));</span>
            <span class="n">zeroCells</span><span class="p">(</span><span class="n">adjointTransposeConvection</span><span class="p">,</span> <span class="n">inletCells</span><span class="p">);</span>
            <span class="n">fvVectorMatrix</span> <span class="nf">UaEqn</span>
            <span class="p">(</span>
                <span class="n">fvm</span><span class="o">::</span><span class="n">div</span><span class="p">(</span><span class="o">-</span><span class="n">phi</span><span class="p">,</span> <span class="n">Ua</span><span class="p">)</span>
              <span class="o">-</span> <span class="n">adjointTransposeConvection</span>
              <span class="o">+</span> <span class="n">turbulence</span><span class="o">-&gt;</span><span class="n">divDevSigma</span><span class="p">(</span><span class="n">Ua</span><span class="p">)</span>
              <span class="o">+</span> <span class="n">fvm</span><span class="o">::</span><span class="n">Sp</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Ua</span><span class="p">)</span>
            <span class="p">);</span>
            <span class="n">UaEqn</span><span class="p">.</span><span class="n">relax</span><span class="p">()</span>
            <span class="n">solve</span><span class="p">(</span><span class="n">UaEqn</span> <span class="o">==</span> <span class="o">-</span><span class="n">fvc</span><span class="o">::</span><span class="n">grad</span><span class="p">(</span><span class="n">pa</span><span class="p">));</span>
</code></pre></td></tr></table>
</div>
</div><p>$$
-\nabla (\mathbf{vu})-\nabla \mathbf{u}\cdot \mathbf{v} = -\nabla{q}+\nabla \cdot (2\nu D(\mathbf{u}))-\alpha \mathbf{u}\\ \nabla \cdot \mathbf{u} = 0
$$</p>
<p>注意到在这里，单独对 $\nabla \mathbf{u\cdot v}$ 在入口边界处置为0，并且处理为显式的源项。我认为这样处理是出于问题适定性的需要，正如前文处理入口边界将伴随压力设置为零梯度一样，将这项消去使得伴随方程和原始方程在入口边界完全一致。</p>
<h3 id="42-边界条件的处理">4.2 边界条件的处理</h3>
<p>对于入口边界以及壁面，满足以下的边界条件
$$
u_t = 0\\ u_n = v_n\\ \mathbf{n}\cdot \nabla q = 0
$$
即对于速度，壁面使用无滑移条件，入口使用固定值并与原始变量保持一致；在入口和壁面处压力施加零梯度条件。</p>
<p>对于出口边界，则比较复杂。前面推导的边界条件
$$
\mathbf{n}(\mathbf{u} \cdot \mathbf{v})+\mathbf{u}(\mathbf{v} \cdot \mathbf{n})+v(\mathbf{n} \cdot \nabla) \mathbf{u}-q \mathbf{n}-p\mathbf{n}-(\mathbf{v\cdot n})\cdot \mathbf{v}-\frac{1}{2}v^2\mathbf{n}=0
$$
注意原始变量取为零压力，零速度梯度，将其按照法向和切向分解，得到
$$
q = \mathbf{u\cdot v}+u_nv_n+\nu(\mathbf{n}\cdot \nabla)u_n-\frac{1}{2}v^2-v_n^2\\ 0 = v_n(\mathbf{u_t-v_t})+\nu(\mathbf{n}\cdot \nabla)\mathbf{u_t}
$$
分别代表伴随压力和伴随速度满足的边界条件。在计算法向梯度时，使用近似
$$
\nu(\mathbf{n\cdot \nabla})u_n = \nu\frac{u_n - u_{n,neighbor}}{\Delta}\\ \nu(\mathbf{n\cdot \nabla})\mathbf{u_t} = \nu\frac{\mathbf{u_t - u_{t,neighbor}}}{\Delta}
$$
因此出口处的压力边界表示为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">const</span> <span class="n">fvsPatchField</span><span class="o">&lt;</span><span class="n">scalar</span><span class="o">&gt;&amp;</span> <span class="n">phip</span> <span class="o">=</span>
	<span class="n">patch</span><span class="p">().</span><span class="n">lookupPatchField</span><span class="o">&lt;</span><span class="n">surfaceScalarField</span><span class="p">,</span> <span class="n">scalar</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;phi&#34;</span><span class="p">);</span> 
<span class="k">const</span> <span class="n">fvsPatchField</span><span class="o">&lt;</span><span class="n">scalar</span><span class="o">&gt;&amp;</span> <span class="n">phiap</span> <span class="o">=</span>
	<span class="n">patch</span><span class="p">().</span><span class="n">lookupPatchField</span><span class="o">&lt;</span><span class="n">surfaceScalarField</span><span class="p">,</span> <span class="n">scalar</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;phia&#34;</span><span class="p">);</span> 
<span class="k">const</span> <span class="n">fvPatchField</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&gt;&amp;</span> <span class="n">Up</span> <span class="o">=</span>
	<span class="n">patch</span><span class="p">().</span><span class="n">lookupPatchField</span><span class="o">&lt;</span><span class="n">volVectorField</span><span class="p">,</span> <span class="n">vector</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;U&#34;</span><span class="p">);</span>
<span class="k">const</span> <span class="n">fvPatchField</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&gt;&amp;</span> <span class="n">Uap</span> <span class="o">=</span>
	<span class="n">patch</span><span class="p">().</span><span class="n">lookupPatchField</span><span class="o">&lt;</span><span class="n">volVectorField</span><span class="p">,</span> <span class="n">vector</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;Ua&#34;</span><span class="p">);</span>

<span class="k">const</span> <span class="n">incompressible</span><span class="o">::</span><span class="n">RASModel</span><span class="o">&amp;</span> <span class="n">rasModel</span> <span class="o">=</span> 
	<span class="n">db</span><span class="p">().</span><span class="n">lookupObject</span><span class="o">&lt;</span><span class="n">incompressible</span><span class="o">::</span><span class="n">RASModel</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;momentumTransport&#34;</span><span class="p">);</span>
<span class="n">scalarField</span> <span class="n">nueff</span> <span class="o">=</span> <span class="n">rasModel</span><span class="p">.</span><span class="n">nuEff</span><span class="p">()().</span><span class="n">boundaryField</span><span class="p">()[</span><span class="n">patch</span><span class="p">().</span><span class="n">index</span><span class="p">()];</span>
<span class="k">const</span> <span class="n">scalarField</span><span class="o">&amp;</span> <span class="n">deltainv</span> <span class="o">=</span> <span class="n">patch</span><span class="p">().</span><span class="n">deltaCoeffs</span><span class="p">();</span> <span class="c1">// m^-1
</span><span class="c1"></span><span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="n">phip</span><span class="o">*</span><span class="n">phiap</span><span class="o">/</span><span class="n">sqr</span><span class="p">(</span><span class="n">patch</span><span class="p">().</span><span class="n">magSf</span><span class="p">())</span> <span class="o">+</span> 
	<span class="p">(</span><span class="n">Uap</span><span class="o">&amp;</span><span class="n">Up</span><span class="p">)</span> <span class="o">+</span> 
	<span class="n">nueff</span><span class="o">*</span><span class="n">deltainv</span><span class="o">*</span><span class="p">(</span><span class="n">phiap</span><span class="o">/</span><span class="n">patch</span><span class="p">().</span><span class="n">magSf</span><span class="p">()</span> <span class="o">-</span> 
	<span class="p">(</span><span class="n">Uap</span><span class="p">.</span><span class="n">patchInternalField</span><span class="p">()</span><span class="o">&amp;</span><span class="n">patch</span><span class="p">().</span><span class="n">nf</span><span class="p">()))</span> <span class="o">-</span> 
	<span class="mf">0.5</span><span class="o">*</span><span class="n">sqr</span><span class="p">(</span><span class="n">mag</span><span class="p">(</span><span class="n">Up</span><span class="p">))</span> <span class="o">-</span> 
	<span class="n">magSqr</span><span class="p">(</span><span class="n">Up</span><span class="o">&amp;</span><span class="n">patch</span><span class="p">().</span><span class="n">Sf</span><span class="p">()</span><span class="o">/</span><span class="n">patch</span><span class="p">().</span><span class="n">magSf</span><span class="p">()));</span>

<span class="n">fixedValueFvPatchScalarField</span><span class="o">::</span><span class="n">updateCoeffs</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div><p>速度边界表示为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">const</span> <span class="n">fvsPatchField</span><span class="o">&lt;</span><span class="n">scalar</span><span class="o">&gt;&amp;</span> <span class="n">phiap</span> <span class="o">=</span>
	<span class="n">patch</span><span class="p">().</span><span class="n">lookupPatchField</span><span class="o">&lt;</span><span class="n">surfaceScalarField</span><span class="p">,</span> <span class="n">scalar</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;phia&#34;</span><span class="p">);</span>
<span class="k">const</span> <span class="n">fvsPatchField</span><span class="o">&lt;</span><span class="n">scalar</span><span class="o">&gt;&amp;</span> <span class="n">phip</span> <span class="o">=</span>
	<span class="n">patch</span><span class="p">().</span><span class="n">lookupPatchField</span><span class="o">&lt;</span><span class="n">surfaceScalarField</span><span class="p">,</span> <span class="n">scalar</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;phi&#34;</span><span class="p">);</span>
<span class="k">const</span> <span class="n">fvPatchField</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&gt;&amp;</span> <span class="n">Up</span> <span class="o">=</span>
	<span class="n">patch</span><span class="p">().</span><span class="n">lookupPatchField</span><span class="o">&lt;</span><span class="n">volVectorField</span><span class="p">,</span> <span class="n">vector</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;U&#34;</span><span class="p">);</span>
<span class="k">const</span> <span class="n">fvPatchField</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&gt;&amp;</span> <span class="n">Uap</span> <span class="o">=</span>
	<span class="n">patch</span><span class="p">().</span><span class="n">lookupPatchField</span><span class="o">&lt;</span><span class="n">volVectorField</span><span class="p">,</span> <span class="n">vector</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;Ua&#34;</span><span class="p">);</span>

<span class="k">const</span> <span class="n">incompressible</span><span class="o">::</span><span class="n">RASModel</span><span class="o">&amp;</span> <span class="n">rasModel</span> <span class="o">=</span> 
    <span class="n">db</span><span class="p">().</span><span class="n">lookupObject</span><span class="o">&lt;</span><span class="n">incompressible</span><span class="o">::</span><span class="n">RASModel</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;momentumTransport&#34;</span><span class="p">);</span>
<span class="k">const</span> <span class="n">scalarField</span> <span class="n">deltainv</span> <span class="o">=</span> <span class="n">patch</span><span class="p">().</span><span class="n">deltaCoeffs</span><span class="p">();</span>
<span class="n">scalarField</span> <span class="n">nueff</span> <span class="o">=</span> <span class="n">rasModel</span><span class="p">.</span><span class="n">nuEff</span><span class="p">()().</span><span class="n">boundaryField</span><span class="p">()[</span><span class="n">patch</span><span class="p">().</span><span class="n">index</span><span class="p">()];</span>
<span class="n">scalarField</span> <span class="nf">Un</span><span class="p">(</span><span class="n">mag</span><span class="p">(</span><span class="n">patch</span><span class="p">().</span><span class="n">nf</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">Up</span><span class="p">));</span>
<span class="n">vectorField</span> <span class="nf">Ut</span><span class="p">(</span><span class="n">Up</span> <span class="o">-</span> <span class="n">phip</span><span class="o">*</span><span class="n">patch</span><span class="p">().</span><span class="n">nf</span><span class="p">()</span><span class="o">/</span><span class="n">patch</span><span class="p">().</span><span class="n">magSf</span><span class="p">());</span>
<span class="n">vectorField</span> <span class="nf">Uaneigh</span><span class="p">(</span><span class="n">Uap</span><span class="p">.</span><span class="n">patchInternalField</span><span class="p">());</span>
<span class="n">vectorField</span> <span class="nf">Uaneigh_n</span><span class="p">((</span><span class="n">Uaneigh</span><span class="o">&amp;</span><span class="n">patch</span><span class="p">().</span><span class="n">nf</span><span class="p">())</span><span class="o">*</span><span class="n">patch</span><span class="p">().</span><span class="n">nf</span><span class="p">());</span>
<span class="n">vectorField</span> <span class="nf">Uaneigh_t</span><span class="p">(</span><span class="n">Uaneigh</span> <span class="o">-</span> <span class="n">Uaneigh_n</span><span class="p">);</span>
<span class="c1">// Ut = (V-Vn)/Vn
</span><span class="c1"></span><span class="n">vectorField</span> <span class="nf">Uap_t</span><span class="p">((</span><span class="n">Un</span><span class="o">*</span><span class="n">Ut</span> <span class="o">+</span> <span class="n">nueff</span><span class="o">*</span><span class="n">deltainv</span><span class="o">*</span><span class="n">Uaneigh_t</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Un</span> <span class="o">+</span> <span class="n">deltainv</span><span class="o">*</span><span class="n">nueff</span><span class="p">));</span>
<span class="n">vectorField</span> <span class="nf">Uap_n</span><span class="p">(</span><span class="n">phiap</span><span class="o">*</span><span class="n">patch</span><span class="p">().</span><span class="n">nf</span><span class="p">()</span><span class="o">/</span><span class="n">patch</span><span class="p">().</span><span class="n">magSf</span><span class="p">());</span>
<span class="c1">// U = Un + Ut
</span><span class="c1">// Un = phi*\vec{A}/(A^2)
</span><span class="c1"></span><span class="n">vectorField</span><span class="o">::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">Uap_t</span> <span class="o">+</span> <span class="n">Uap_n</span><span class="p">);</span>

<span class="n">fixedValueFvPatchVectorField</span><span class="o">::</span><span class="n">updateCoeffs</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="43-梯度下降法-deepest-descent-method">4.3 梯度下降法 （Deepest descent method）</h3>
<p>完成伴随方程计算后，需要更新孔隙率，如前文推导
$$
\frac{\partial L}{\partial \alpha_i} =\mathbf{u_i\cdot v_i V_i}
$$
按照梯度下降的方向寻找目标函数极值，定义步长为 $\lambda$ 。则
$$
\alpha_{n+1} = \alpha_{n} - \mathbf{u_i\cdot v_i}V_i\lambda
$$
在 *OpenFOAM* 的实现中，我们需要注意给 $\alpha$ 施加限制 $\alpha &lt; \alpha_{max}$，并施加松弛因子保证稳定性，因此给出以下代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// @mesh.fielfRelaxationFactor : fvSolution定义的松弛因子
</span><span class="c1"></span>        <span class="n">alpha</span> <span class="o">+=</span>
            <span class="n">mesh</span><span class="p">.</span><span class="n">fieldRelaxationFactor</span><span class="p">(</span><span class="s">&#34;alpha&#34;</span><span class="p">)</span>
           <span class="o">*</span><span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">lambda</span><span class="o">*</span><span class="p">(</span><span class="n">Ua</span> <span class="o">&amp;</span> <span class="n">U</span><span class="p">),</span> <span class="n">zeroAlpha</span><span class="p">),</span> <span class="n">alphaMax</span><span class="p">)</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="44-算例">4.4 算例</h3>
<p>测试算例为 <em>OpenFOAM</em> 自带算例<code>pitzDaily</code>，管道内流动问题，使用 $k-\epsilon$ 湍流模型，采用的物性参数，湍流模型参数以及梯度下降算法参数如下：</p>
<table>
<thead>
<tr>
<th>粘度</th>
<th>入口湍动能</th>
<th>入口湍流耗散率</th>
<th>梯度下降步长</th>
<th>$\alpha_{max}$</th>
</tr>
</thead>
<tbody>
<tr>
<td>$\nu = 1\times 10^{-5}\ m^2/s$</td>
<td>$k = 0.375 \ m^2/s^2$</td>
<td>$\epsilon=14.855\ m^2/s^3$</td>
<td>$\lambda =1\times 10^5\ s/m^2$</td>
<td>$200$</td>
</tr>
</tbody>
</table>
<p>边界条件和使用的网格如下图所示，壁面为无滑移条件。</p>
<table>
<thead>
<tr>
<th>变量</th>
<th>Inlet</th>
<th>Outlet</th>
</tr>
</thead>
<tbody>
<tr>
<td>$\mathbf{v}$</td>
<td>固定值 $10\  m/s$</td>
<td>零梯度</td>
</tr>
<tr>
<td>$\mathbf{u}$</td>
<td>固定值 $10\ m/s$</td>
<td>伴随速度条件</td>
</tr>
<tr>
<td>$p$</td>
<td>零梯度</td>
<td>固定值 $0\ \rm pa$</td>
</tr>
<tr>
<td>$q$</td>
<td>零梯度</td>
<td>伴随压力条件</td>
</tr>
</tbody>
</table>
<figure>
    <img src="/images/Adjoint-Method/pitzdaily.png"/> <figcaption>
            <h4>Mesh</h4>
        </figcaption>
</figure>

<p>N-S方程和伴随方程的求解采用SIMPLE算法 ，$\alpha$ 松弛因子设为0.1。每步计算收敛条件为相对残差小于0.1或绝对残差小于1e-8。为保证稳定性，N-S方程对流项使用二阶迎风格式，伴随方程及湍流模型有关项使用一阶迎风格式。最终得到 $\alpha$ 的分布情况：</p>
<figure>
    <img src="/images/Adjoint-Method/alpha.png"/> <figcaption>
            <h4>$\alpha$</h4>
        </figcaption>
</figure>

<p>可以看到，$\alpha$ 值大的地方也就是被惩罚的区域，将这部分挖掉后流动将更加自然，台阶处的涡消失。</p>
<figure>
    <img src="/images/Adjoint-Method/velocity.png"/> <figcaption>
            <h4>$v$</h4>
        </figcaption>
</figure>

<figure>
    <img src="/images/Adjoint-Method/pressure.png"/> <figcaption>
            <h4>$p$</h4>
        </figcaption>
</figure>

<p>可以计算出损失函数 $J$ 的变化情况，与不进行伴随优化的解对比，实现了流动能量损失的减小。</p>
<figure>
    <img src="/images/Adjoint-Method/dissipation.png"/> <figcaption>
            <h4>Dissipation Rate</h4>
        </figcaption>
</figure>

<h2 id="5-总结">5. 总结</h2>
<p>伴随优化方法可以扩展到流动、传热、结构耦合问题的求解，也可以与基于梯度的其他优化算法相结合；不仅可以进行形状优化，也可以扩展到其他多参数，目前正得到越来越多的应用。</p>
<h4 id="参考资料">参考资料</h4>
<ul>
<li>[1] C. Othmer, A continuous adjoint formulation for the computation of topological and surface sensitivities of ducted flows</li>
<li>[2] Andrew M. Bradley, PDE-constrained optimization and the adjoint method</li>
<li>[3] Luis Fernando Garcia Rodriguez, Topology Optimisation of Fluids Through the Continuous Adjoint Approach in OpenFOAM</li>
<li>[4] Ulf Nilsson, Description of adjointShapeOptimizationFoam and how to implement new objective functions</li>
</ul></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>本文于 2020-12-03 更新</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/2020/adjoint-optimization/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/adjoint-method/">Adjoint Method</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/2020/optimize-code/" class="prev" rel="prev" title="Optimize Code"><i class="fas fa-angle-left fa-fw"></i>Optimize Code</a>
            <a href="/2020/ferziger-on-les/" class="next" rel="next" title="Ferziger and Blazek on LES">Ferziger and Blazek on LES<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.72.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.0"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Fr13ndSDP</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript">
    window.config = {"code":{"copyTitle":"复制到剪贴板","maxShownLines":30},"comment":{},"headerMode":{"desktop":"fixed","mobile":"auto"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};
</script><script type="text/javascript" src="https://polyfill.io/v3/polyfill.min.js?features=Element.prototype.closest%2CrequestAnimationFrame%2CCustomEvent%2CPromise%2CObject.entries%2CObject.assign%2CObject.values%2Cfetch%2CElement.prototype.after%2CArray.prototype.fill%2CIntersectionObserver%2CArray.from%2CArray.prototype.find%2CMath.sign"></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
